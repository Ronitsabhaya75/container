name: Test OpenSSL Curl Fix

on:
  push:
    branches:
      - curl-testing
      - x64-64-rosetta-issue
  pull_request:
    paths:
      - 'Sources/Services/ContainerSandboxService/**'
      - '.github/workflows/test-openssl-curl.yml'

jobs:
  test-curl:
    name: Test HTTPS in x86_64 container
    runs-on: macos-15  # Latest available GitHub-hosted macOS runner
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download prebuilt container CLI
        run: |
          echo "Downloading latest container CLI release..."
          # Get latest release from GitHub
          LATEST_URL=$(curl -s https://api.github.com/repos/apple/container/releases/latest | grep "browser_download_url.*container-.*-macos.tar.gz" | cut -d '"' -f 4 | head -n 1)
          
          if [ -z "$LATEST_URL" ]; then
            echo "No prebuilt binary found, using brew instead"
            brew install container
          else
            echo "Downloading from: $LATEST_URL"
            curl -L -o container.tar.gz "$LATEST_URL"
            tar -xzf container.tar.gz
            chmod +x container
            sudo mv container /usr/local/bin/
          fi
          
          container --version
      
      - name: Test curl in AlmaLinux 10 x86_64 container
        run: |
          set -e
          
          echo "Testing HTTPS connections in x86_64 container..."
          
          # Run container and test curl
          ./build/container run --rm --arch=x86_64 almalinux:10 /bin/bash -c '
            echo "Container architecture: $(uname -m)"
            echo "Testing curl to https://mirrors.almalinux.org"
            curl -v --max-time 30 https://mirrors.almalinux.org 2>&1 | tee /tmp/curl_output.txt
            
            # Check if curl succeeded
            if grep -q "error:030000EA:digital envelope routines::provider signature failure" /tmp/curl_output.txt; then
              echo "❌ FAILED: OpenSSL certificate verification error still occurs"
              exit 1
            fi
            
            if grep -q "TLS connect error" /tmp/curl_output.txt; then
              echo "❌ FAILED: TLS connection failed"
              exit 1
            fi
            
            echo "✅ SUCCESS: HTTPS curl worked correctly"
          '
        
      - name: Test dnf package manager
        run: |
          set -e
          
          echo "Testing dnf package manager in x86_64 container..."
          
          ./build/container run --rm --arch=x86_64 almalinux:10 /bin/bash -c '
            echo "Attempting to refresh package metadata..."
            if dnf upgrade -y --refresh --downloadonly 2>&1 | tee /tmp/dnf_output.txt; then
              echo "✅ SUCCESS: dnf can download package metadata"
            else
              echo "❌ FAILED: dnf cannot access repositories"
              cat /tmp/dnf_output.txt
              exit 1
            fi
          '
