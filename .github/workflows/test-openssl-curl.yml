name: Test OpenSSL Curl Fix

on:
  push:
    branches:
      - curl-testing
      - x64-64-rosetta-issue
  pull_request:
    paths:
      - 'Sources/Services/ContainerSandboxService/**'
      - '.github/workflows/test-openssl-curl.yml'

jobs:
  test-curl:
    name: Test HTTPS in x86_64 container
    runs-on: macos-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Check if container CLI is available
        id: check_container
        continue-on-error: true
        run: |
          if command -v container &> /dev/null; then
            echo "available=true" >> $GITHUB_OUTPUT
            container --version
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "container CLI not found - this is expected on GitHub-hosted runners"
          fi
      
      - name: Document OpenSSL Issue
        if: steps.check_container.outputs.available != 'true'
        run: |
          echo "::notice::This workflow documents the OpenSSL certificate issue in x86_64 containers on Apple Silicon"
          echo "::notice::The issue: curl https://mirrors.almalinux.org fails with 'error:030000EA:digital envelope routines::provider signature failure'"
          echo "::notice::To reproduce locally on Apple Silicon Mac:"
          echo "::notice::  1. Install container CLI from https://github.com/apple/container"
          echo "::notice::  2. Run: container run --rm --arch=x86_64 almalinux:10 curl -v https://mirrors.almalinux.org"
          echo "::notice::  3. Observe the TLS certificate verification error"
          echo ""
          echo "GitHub-hosted runners cannot run this test because:"
          echo "  - container CLI requires Swift 6.2 (runners have 6.1)"  
          echo "  - brew install requires Xcode 26 on macOS 16+ (runners have macOS 15)"
          echo ""
          echo "This workflow will run successfully when:"
          echo "  - PR is merged to apple/container with self-hosted Tahoe runners"
          echo "  - GitHub Actions updates to macOS 16 with Xcode 26"
      
      - name: Test curl in AlmaLinux 10 x86_64 container
        if: steps.check_container.outputs.available == 'true'
        run: |
          set -e
          
          echo "Testing HTTPS connections in x86_64 container..."
          
          # Run container and test curl
          container run --rm --arch=x86_64 almalinux:10 /bin/bash -c '
            echo "Container architecture: $(uname -m)"
            echo "Testing curl to https://mirrors.almalinux.org"
            curl -v --max-time 30 https://mirrors.almalinux.org 2>&1 | tee /tmp/curl_output.txt
            
            # Check if curl succeeded
            if grep -q "error:030000EA:digital envelope routines::provider signature failure" /tmp/curl_output.txt; then
              echo "❌ FAILED: OpenSSL certificate verification error still occurs"
              exit 1
            fi
            
            if grep -q "TLS connect error" /tmp/curl_output.txt; then
              echo "❌ FAILED: TLS connection failed"
              exit 1
            fi
            
            echo "✅ SUCCESS: HTTPS curl worked correctly"
          '
